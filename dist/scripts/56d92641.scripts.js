"use strict";angular.module("londonBusStopsApp",["ui.map","ui.event"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MapsCtrl"}).when("/busStop/:busStopId",{templateUrl:"views/next_arrivals.html",controller:"ArrivalsCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("londonBusStopsApp").controller("MapsCtrl",["$scope","$location","NextarrivalsService",function(a,b,c){function d(){jQuery(".map-container").addClass("no-location")}function e(){a.ajaxInProgress=!0,a.currentAction="bus";var b,d,e=a.myMap.getBounds(),f=e.getNorthEast(),g=e.getSouthWest();c.getBusStops(f,g).then(function(c){a.ajaxInProgress=!1,a.currentAction=!1,jQuery.each(c.markers,function(c,e){d=new google.maps.LatLng(e.lat,e.lng),b=new google.maps.Marker({map:a.myMap,position:d,icon:"images/london-buses-logo.png"}),b.stopInfo=e,a.busStops.push(b)})})}a.busStops=[],a.detailview=!1,a.isDetailsLoading=!1,a.ajaxInProgress=!1,a.currentAction=!1;var f;a.showNextArrivals=function(b){a.detailview=!0,a.isDetailsLoading=!0,a.busStopInfo=b.stopInfo,a.currentAction="next",c.getNextArrivals(b.stopInfo.id).then(function(b){a.isDetailsLoading=!1,a.nextArrivals=b,a.currentAction=!1})},a.closeNextArrivals=function(){a.detailview=!1,a.nextArrivals=[]},a.mapOptions={center:new google.maps.LatLng(51.511214,-.119824),zoom:13,mapTypeId:google.maps.MapTypeId.ROADMAP},navigator.geolocation?(a.currentAction="geo",navigator.geolocation.getCurrentPosition(function(b){f=new google.maps.LatLng(b.coords.latitude,b.coords.longitude),a.myMap.setCenter(f),a.myMap.setZoom(17),a.currentAction=!1,e(),google.maps.event.clearListeners(a.myMap,"click"),google.maps.event.addListener(a.myMap,"zoom_changed",function(){e()}),google.maps.event.addListener(a.myMap,"center_changed",function(){e()})},function(){d()})):d()}]),angular.module("londonBusStopsApp").service("NextarrivalsService",["$http","$q","$routeParams",function(a,b){this.getBusStops=function(c,d){var e=b.defer(),f="http://digitaslbi-id-test.herokuapp.com/bus-stops?northEast="+c.lb+","+c.mb+"&southWest="+d.lb+","+d.mb+"&callback=JSON_CALLBACK";return a.jsonp(f).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise},this.getNextArrivals=function(c){var d=b.defer(),e="http://digitaslbi-id-test.herokuapp.com/bus-stops/"+c+"?callback=JSON_CALLBACK";return a.jsonp(e).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise}}]),angular.module("londonBusStopsApp").directive("loading",function(){return{restrict:"E",replace:!0,template:'<div class="loading"></div>',link:function(a,b){a.$watch("ajaxInProgress",function(a){a?(jQuery(b).spin("large").show(),jQuery(b).parent().addClass("busy")):(jQuery(b).spin(!1).hide(),jQuery(b).parent().removeClass("busy"))})}}}).directive("loadingdetails",function(){return{restrict:"E",replace:!0,template:'<div class="loading"></div>',link:function(a,b){a.$watch("isDetailsLoading",function(a){a?(jQuery(b).spin("large").show(),jQuery(b).parent().addClass("busy")):(jQuery(b).spin(!1).hide(),jQuery(b).parent().removeClass("busy"))})}}}),angular.module("londonBusStopsApp").directive("status",function(){return{template:"<div></div>",restrict:"E",replace:!0,link:function(a,b){a.$watch("currentAction",function(a){var c="";switch(a){case"geo":c="Getting current position…";break;case"bus":c="Retriving bus stops…";break;case"next":c="Next bus coming in…";break;default:c=""}a&&c?jQuery(b).html('<div class="alert alert-info status-update">'+c+"</div>").show():jQuery(b).empty().hide()})}}});